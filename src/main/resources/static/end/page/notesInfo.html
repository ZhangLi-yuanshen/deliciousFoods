<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <meta http-equiv="pragma" content="no-cache" />
    <meta http-equiv="content-type" content="no-cache, must-revalidate" />
    <meta http-equiv="expires" content="Wed, 26 Feb 1997 08:21:57 GMT"/>
    <title>笔记信息</title>

    <link href="../css/bootstrap.min.css" rel="stylesheet"/>
    <link href="../css/font-awesome.css" rel="stylesheet"/>
    <link href="../css/basic.css" rel="stylesheet"/>
    <link href="../css/custom.css" rel="stylesheet"/>
    <link href="../css/my.css" rel="stylesheet"/>
    <link href="../css/quill.snow.css" rel="stylesheet">
    <link href="../css/element/index.css" rel="stylesheet"/>

    <style>
        [v-cloak] {
            display: none;
        }
        .ql-snow .ql-editor img {
            width: 400px;
        }
    </style>
</head>

<body>
<div id="wrapper">
    <!-- Navigation and Sidebar omitted for brevity -->
    <div id="page-wrapper">
        <div id="page-inner">
            <div class="row">
                <div class="col-md-12">
                    <h1 class="page-subhead-line">这里是笔记信息信息，管理员可以对公告信息进行修改。</h1>
                </div>
            </div>
            <div class="panel panel-default">
                <div class="panel-heading">
                    笔记信息
                </div>
                <div class="panel-body">
                    <div class="table-responsive">
                        <div class="nx-table-header">
                            <button class="btn btn-sm btn-primary" id="addBtn">新增</button>
                            <input type="text" placeholder="请输入搜索内容" id="searchName">
                            <i class="glyphicon glyphicon-search" id="searchBtn"></i>
                        </div>
                        <table class="table table-striped table-bordered table-hover" id="notesTable">
                            <thead>
                            <tr>
                                <th>ID</th>
                                <th>名称</th>
                                <th>上传时间</th>
                                <th>姓名</th>
                                <th>审核状态</th>
                                <th>操作</th>
                            </tr>
                            </thead>
                            <tbody>
                            <!-- Data rows will be populated here dynamically -->
                            </tbody>
                        </table>
                        <nav aria-label="Page navigation example" id="pagination">
                            <ul class="pagination">
                                <!-- Pagination links will be generated dynamically -->
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<!-- Modal -->
<div id="myModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" data-backdrop="static">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" id="closeBtn" aria-label="Close"><span
                        aria-hidden="true">&times;</span></button>
                请填写信息
            </div>
            <div class="modal-body">
                <input type="text" id="modal-id" style="display: none">
                <div class="form-group" style="margin-bottom: 40px;display: flex;align-items: center;">
                    <label class="col-sm-3 control-label">名称</label>
                    <div class="col-sm-7">
                        <input type="text" class="form-control" id="name" placeholder="请输入名称">
                    </div>
                </div>
                <div class="form-group" style="margin-bottom: 40px;display: flex;align-items: center;">
                    <label class="col-sm-3 control-label">上传时间</label>
                    <div class="col-sm-7">
                        <input type="datetime-local" id="time" />
                    </div>
                </div>
                <div class="form-group" style="margin-bottom: 40px;display: flex;align-items: center;">
                    <label class="col-sm-3 control-label">上传用户</label>
                    <div class="col-sm-7">
                        <select class="form-control" id="userInfo">
                            <option value="">请选择</option>
                        </select>
                    </div>
                </div>

                <div id="editor" style="min-height: 300px"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" id="cancelBtn">取消</button>
                <button type="button" id="saveBtn" class="btn btn-primary">保存</button>
            </div>
        </div>
    </div>
</div>

<script src="../js/jquery-1.10.2.js"></script>
<script src="../js/bootstrap.min.js"></script>
<script src="../js/quill.js"></script>
<script src="../js/element/index.js"></script>
<script src="../js/vue2.6.11/axios.js"></script>

<script>
    let quill = new Quill('#editor', {
        theme: 'snow',
        modules: {
            toolbar: [
                [{'header': [1, 2, 3, 4, 5, 6, false]}],        // 标题字体
                [{'font': []}],                                 // 字体
                ['bold', 'italic', 'underline', 'strike'],        // 切换按钮
                [{'align': []}],                                // 对齐方式
                ['blockquote', 'code-block'],                     // 文本块/代码块
                [{'list': 'ordered'}, {'list': 'bullet'}],     // 有序/无序列表
                [{'indent': '-1'}, {'indent': '+1'}],          // 减少缩进/缩进
                [{'color': []}, {'background': []}],          // 主题默认下拉，使用主题提供的值
                ['clean'],                                        // 清除格式
                ['image', 'link', 'video']                        // 图片 / 链接 / 视频
            ]
        }
    });

    $(document).ready(function() {
        let user = JSON.parse(localStorage.getItem('user'));
        let permission = [];
        let authority = [];
        let tableData = [];
        let pageInfo = {};
        let modalData = {};

        // Load user permissions
        axios.get("/permission/9").then(res => {
            if (res.data.code === '0') {
                permission = res.data.data;
            } else {
                msg('error', res.data.msg);
            }
        });

        // Load user authority
        axios.get("/authority").then(res => {
            if (res.data.code === '0') {
                authority = res.data.data;
            } else {
                msg('error', res.data.msg);
            }
        });

        // Load users for selection
        axios.get("/userInfo").then(res => {
            if (res.data.code === '0') {
                let list = res.data.data;
                list.forEach(item => {
                    $('#userInfo').append('<option value="'+item.id+'" name="'+item.name+'">'+item.name+'</option>');
                })
            } else {
                msg('error', res.data.msg);
            }
        });

        // Load table data
        function loadTable(pageNum) {
            let name = $('#searchName').val() || "all";
            let url = "/notesInfo/page/" + name + "?pageNum=" + pageNum;
            if (user.level !== 1) {
                url += "&userId=" + user.id;
            }
            axios.get(url).then(res => {
                if (res.data.code === '0') {
                    tableData = res.data.data.list;
                    pageInfo = res.data.data;

                    // Populate table rows
                    let tableBody = '';
                    tableData.forEach(function(item) {
                        let statusDesc = item.status === 0 ? '未审核' : item.status === 1 ? '通过' : '驳回';
                        tableBody += `
                            <tr>
                                <td>${item.id}</td>
                                <td>${item.name}</td>
                                <td>${item.time}</td>
                                <td>${item.userName}</td>
                                <td>${statusDesc}</td>
                                <td>
                                    <button class="btn btn-success btn-xs editBtn" data-id="${item.id}">编辑</button>
                                    <button class="btn btn-danger btn-xs delBtn" data-id="${item.id}">删除</button>
                                    <button class="btn btn-primary btn-xs checkBtn" data-id="${item.id}" data-status="1" ${user.level === 1 ? '' : 'style="display:none"'}>通过</button>
                                    <button class="btn btn-warning btn-xs checkBtn" data-id="${item.id}" data-status="2" ${user.level === 1 ? '' : 'style="display:none"'}>驳回</button>
                                </td>
                            </tr>
                        `;
                    });
                    $('#notesTable tbody').html(tableBody);

                    // Populate pagination
                    let pagination = '';
                    for (let i = 1; i <= pageInfo.pages; i++) {
                        pagination += `<li class="page-item ${i === pageInfo.pageNum ? 'active' : ''}"><a class="page-link" href="#">${i}</a></li>`;
                    }
                    $('#pagination .pagination').html(pagination);
                } else {
                    msg('error', res.data.msg);
                }
            });
        }

        // Event handlers
        $('#searchBtn').click(function() {
            loadTable(1);
        });

        $('#addBtn').click(function() {
            modalData = {};
            $('#name').val('');
            $('#time').val('');
            $('#userInfo').val('');
            quill.root.innerHTML = '';
            $('#myModal').modal('show');
        });

        $('#cancelBtn').click(function() {
            $('#myModal').modal('hide');
        });

        $('#saveBtn').click(function() {
            let id = $('#modal-id').val();
            let name = $('#name').val();
            let time = $('#time').val();
            let userId = $('#userInfo').val();
            let content = quill.root.innerHTML;

            let url = id ? '/notesInfo/update' : '/notesInfo/save';
            let method = id ? 'put' : 'post';
            let data = { name, time, userId, content };
            if (id) {
                data.id = id;
            }

            axios({
                method: method,
                url: url,
                data: data
            }).then(res => {
                if (res.data.code === '0') {
                    $('#myModal').modal('hide');
                    loadTable(1);
                } else {
                    msg('error', res.data.msg);
                }
            });
        });

        $(document).on('click', '.editBtn', function() {
            let id = $(this).data('id');
            let note = tableData.find(item => item.id === id);
            if (note) {
                $('#modal-id').val(note.id);
                $('#name').val(note.name);
                $('#time').val(note.time);
                $('#userInfo').val(note.userId);
                quill.root.innerHTML = note.content;
                $('#myModal').modal('show');
            }
        });

        $(document).on('click', '.delBtn', function() {
            let id = $(this).data('id');
            if (confirm('确定删除吗？')) {
                axios.delete(`/notesInfo/${id}`).then(res => {
                    if (res.data.code === '0') {
                        loadTable(1);
                    } else {
                        msg('error', res.data.msg);
                    }
                });
            }
        });

        $(document).on('click', '.checkBtn', function() {
            let id = $(this).data('id');
            let status = $(this).data('status');
            axios.put(`/notesInfo/status/${id}`, { status }).then(res => {
                if (res.data.code === '0') {
                    loadTable(1);
                } else {
                    msg('error', res.data.msg);
                }
            });
        });

        $(document).on('click', '#pagination .page-link', function(e) {
            e.preventDefault();
            let pageNum = parseInt($(this).text());
            loadTable(pageNum);
        });

        loadTable(1);
    });
</script>
</body>
</html>
