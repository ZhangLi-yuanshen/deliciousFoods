<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <meta http-equiv="pragma" content="no-cache" />
    <meta http-equiv="content-type" content="no-cache, must-revalidate" />
    <meta http-equiv="expires" content="Wed, 26 Feb 1997 08:21:57 GMT"/>
    <title>公告信息</title>

    <link href="../css/bootstrap.min.css" rel="stylesheet"/>
    <link href="../css/font-awesome.css" rel="stylesheet"/>
    <link href="../css/basic.css" rel="stylesheet"/>
    <link href="../css/custom.css" rel="stylesheet"/>
    <link href="../css/my.css" rel="stylesheet"/>
    <link href="../css/quill.snow.css" rel="stylesheet">
    <link href="../css/element/index.css" rel="stylesheet"/>

    <style>
        [v-cloak] {
            display: none;
        }
        .ql-snow .ql-editor img {
            width: 400px;
        }
    </style>
</head>

<body>
<div id="wrapper">
    <!-- Header, Navigation, Sidebar omitted for brevity -->

    <div id="page-wrapper">
        <div id="page-inner">
            <div class="row">
                <div class="col-md-12">
                    <h1 class="page-subhead-line">这里是公告信息，管理员可以对公告信息进行修改。</h1>
                </div>
            </div>
            <div class="panel panel-default">
                <div class="panel-heading">
                    系统公告
                </div>
                <div class="panel-body">
                    <div class="table-responsive">
                        <div class="nx-table-header">
                            <button class="btn btn-sm btn-primary" id="addBtn">新增</button>
                            <input type="text" placeholder="请输入搜索内容" id="searchName">
                            <i class="glyphicon glyphicon-search" id="searchBtn"></i>
                        </div>
                        <table class="table table-striped table-bordered table-hover" id="advertiserTable">
                            <thead>
                            <tr>
                                <th>ID</th>
                                <th>公告标题</th>
                                <th>公告时间</th>
                                <th>操作</th>
                            </tr>
                            </thead>
                            <tbody>
                            <!-- Data will be dynamically loaded here -->
                            </tbody>
                        </table>
                        <nav aria-label="Page navigation example">
                            <ul class="pagination" id="pagination">
                                <!-- Pagination will be dynamically generated -->
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal for editing/adding data -->
<div id="myModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" data-backdrop="static">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" id="closeBtn" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                公告信息
            </div>
            <div class="modal-body">
                <input type="text" id="modal-id" style="display: none">
                <div class="form-group" style="margin-bottom: 40px;display: flex;align-items: center;">
                    <label class="col-sm-2 control-label">公告标题:</label>
                    <input id="modal-name" style="width: 200px" type="text" class="form-control" placeholder="请输入公告标题">
                </div>
                <div id="editor" style="min-height: 300px"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" id="cancelBtn">取消</button>
                <button type="button" id="saveBtn" class="btn btn-primary">保存</button>
            </div>
        </div>
    </div>
</div>

<script src="../js/jquery-1.10.2.js"></script>
<script src="../js/bootstrap.min.js"></script>
<script src="../js/quill.js"></script>

<script>
    let quill = new Quill('#editor', {
        theme: 'snow',
        modules: {
            toolbar: [
                [{'header': [1, 2, 3, 4, 5, 6, false]}],
                [{'font': []}],
                ['bold', 'italic', 'underline', 'strike'],
                [{'align': []}],
                ['blockquote', 'code-block'],
                [{'header': 1}, {'header': 2}],
                [{'list': 'ordered'}, {'list': 'bullet'}],
                [{'indent': '-1'}, {'indent': '+1'}],
                [{'color': []}, {'background': []}],
                ['clean'],
                ['image', 'link', 'video']
            ]
        }
    });

    $(document).ready(function() {
        // Initialize user and permissions
        let user = JSON.parse(localStorage.getItem('user'));
        let authority = [];
        let permission = [];

        // Fetch permissions and authority
        $.get("/permission/1000001", function(res) {
            if (res.data.code === '0') {
                permission = res.data.data;
            } else {
                alert('Error: ' + res.data.msg);
            }
        });

        $.get("/authority", function(res) {
            if (res.data.code === '0') {
                authority = res.data.data;
            } else {
                alert('Error: ' + res.data.msg);
            }
        });

        // Load table data
        loadTable(1);

        // Event listeners
        $('#addBtn').click(function() {
            // if (permission.indexOf(1) === -1) {
            //     alert('你没有权限操作');
            //     return;
            // }
            resetModal();
            $('#myModal').modal('show');
        });

        $('#searchBtn').click(function() {
            loadTable(1);
        });

        $('#saveBtn').click(function() {
            let entity = {
                name: $('#modal-name').val(),
                content: quill.root.innerHTML
            };
            let id = $('#modal-id').val();
            if (id) {
                entity.id = id;
                $.ajax({
                    url: "/advertiserInfo",
                    method: "PUT",
                    data: entity,
                    success: function(res) {
                        if (res.code === '0') {
                            alert('更新成功');
                            loadTable(1);
                            $('#myModal').modal('hide');
                        } else {
                            alert('错误: ' + res.msg);
                        }
                    }
                });
            } else {
                $.ajax({
                    url: "/advertiserInfo",
                    method: "POST",
                    data: entity,
                    success: function(res) {
                        if (res.code === '0') {
                            alert('添加成功');
                            loadTable(1);
                            $('#myModal').modal('hide');
                        } else {
                            alert('错误: ' + res.msg);
                        }
                    }
                });
            }
        });

        $('#cancelBtn').click(function() {
            $('#myModal').modal('hide');
        });

        $('#closeBtn').click(function() {
            $('#myModal').modal('hide');
        });

        // Load table function
        function loadTable(pageNum) {
            let name = $('#searchName').val() || "all";
            $.get(`/advertiserInfo/page/${name}?pageNum=${pageNum}`, function(res) {
                if (res.code === '0') {
                    let data = res.data;
                    let tableHtml = '';
                    data.list.forEach(function(item) {
                        tableHtml += `<tr>
                            <td>${item.id}</td>
                            <td>${item.name}</td>
                            <td>${item.time}</td>
                            <td>
                                <button class="btn btn-success btn-xs editBtn" data-id="${item.id}">编辑</button>
                                <button class="btn btn-danger btn-xs delBtn" data-id="${item.id}">删除</button>
                            </td>
                        </tr>`;
                    });
                    $('#advertiserTable tbody').html(tableHtml);

                    // Pagination
                    let paginationHtml = '';
                    if (data.hasPreviousPage) {
                        paginationHtml += `<li><a href="javascript:void(0)" class="page-link" data-page="${data.pageNum - 1}">上一页</a></li>`;
                    }
                    paginationHtml += `<li class="disabled"><span class="page-link">${data.pageNum}</span></li>`;
                    if (data.hasNextPage) {
                        paginationHtml += `<li><a href="javascript:void(0)" class="page-link" data-page="${data.pageNum + 1}">下一页</a></li>`;
                    }
                    $('#pagination').html(paginationHtml);
                } else {
                    alert('错误: ' + res.msg);
                }
            });
        }

        // Edit button
        $('#advertiserTable').on('click', '.editBtn', function() {
            let id = $(this).data('id');
            // if (permission.indexOf(3) === -1) {
            //     alert('你没有权限操作');
            //     return;
            // }
            $.get(`/advertiserInfo/${id}`, function(res) {
                if (res.code === '0') {
                    let data = res.data;
                    $('#modal-id').val(data.id);
                    $('#modal-name').val(data.name);
                    quill.root.innerHTML = data.content;
                    $('#myModal').modal('show');
                } else {
                    alert('错误: ' + res.msg);
                }
            });
        });

        // Delete button
        $('#advertiserTable').on('click', '.delBtn', function() {
            let id = $(this).data('id');
            // if (permission.indexOf(2) === -1) {
            //     alert('你没有权限操作');
            //     return;
            // }
            if (confirm('确认删除？')) {
                $.ajax({
                    url: `/advertiserInfo/${id}`,
                    method: "DELETE",
                    success: function(res) {
                        if (res.code === '0') {
                            alert('删除成功');
                            loadTable(1);
                        } else {
                            alert('错误: ' + res.msg);
                        }
                    }
                });
            }
        });

        function resetModal() {
            $('#modal-id').val('');
            $('#modal-name').val('');
            quill.root.innerHTML = '';
        }
    });
</script>
</body>
</html>
