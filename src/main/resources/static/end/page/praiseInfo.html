<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="pragma" content="no-cache">
    <meta http-equiv="content-type" content="no-cache, must-revalidate">
    <meta http-equiv="expires" content="Wed, 26 Feb 1997 08:21:57 GMT">
    <title>笔记点赞信息</title>

    <link href="../css/bootstrap.min.css" rel="stylesheet"/>
    <link href="../css/font-awesome.css" rel="stylesheet"/>
    <link href="../css/basic.css" rel="stylesheet"/>
    <link href="../css/custom.css" rel="stylesheet"/>
    <link href="../css/element/index.css" rel="stylesheet"/>

    <style>
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
<div id="wrapper">
    <nav class="navbar navbar-default navbar-cls-top " role="navigation" style="margin-bottom: 0">
        <div class="navbar-header">
            <a class="navbar-brand" href="index.html">后端管理系统</a>
        </div>

        <div class="header-right">
            <a href="javascript:void(0)" class="btn btn-info" id="logoutBtn" title="退出登录">
                <i class="fa fa-sign-out fa-2x"></i>
            </a>
        </div>

        <div class="header-right">
            <a href="javascript:void(0)" class="btn btn-info" id="personalPageBtn" title="跳转到个人信息">
                <i class="fa fa-user fa-2x"></i>
            </a>
        </div>

        <div class="header-right" style="padding-top: 25px">欢迎你，<span id="userName"></span></div>

        <div class="header-left">
            <a href="/front/index.html" class="btn btn-info" title="跳转到首页">
                <i class="fa fa-dot-circle-o fa-2x"></i>
            </a>
        </div>
    </nav>

    <nav class="navbar-default navbar-side" role="navigation">
        <div class="sidebar-collapse">
            <ul class="nav" id="main-menu">
                <li><a href="index.html"><i class="fa fa-dashboard"></i>系统首页</a></li>
                <li><a href="#"><i class="fa fa-yelp"></i>信息展示 <span class="fa arrow"></span></a>
                    <ul class="nav nav-second-level collapse in" id="menuItems"></ul>
                </li>
                <li><a href="notesInfoComment.html"><i class="fa fa-file"></i>笔记信息评论</a></li>
                <li><a href="updatePassword.html"><i class="fa fa-unlock-alt"></i>修改密码</a></li>
                <li><a href="javascript:void(0)" id="logoutBtnSidebar"><i class="fa fa-power-off"></i>退出登录</a></li>
            </ul>
        </div>
    </nav>

    <div id="page-wrapper">
        <div id="page-inner">
            <div class="row">
                <div class="col-md-12">
                    <h1 class="page-subhead-line">这是笔记点赞信息页，管理员可以对笔记点赞信息进行操作。</h1>
                </div>
            </div>

            <div class="row">
                <div class="col-md-12">
                    <div class="panel panel-default">
                        <div class="panel-heading">笔记点赞信息表</div>
                        <div class="panel-body">
                            <div class="table-responsive">
                                <div class="nx-table-header">
                                    <button class="btn btn-sm btn-primary" id="addBtn">新增</button>
                                    <input type="text" id="searchInput" placeholder="请输入搜索内容">
                                    <i class="glyphicon glyphicon-search"></i>
                                </div>

                                <table class="table table-striped table-bordered table-hover" id="praiseTable">
                                    <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>名称</th>
                                        <th>时间</th>
                                        <th>关联笔记</th>
                                        <th>操作</th>
                                    </tr>
                                    </thead>
                                    <tbody id="tableBody"></tbody>
                                </table>

                                <nav aria-label="Page navigation example" id="pagination">
                                    <ul class="pagination"></ul>
                                </nav>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal" tabindex="-1" role="dialog" id="mod">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <span class="modal-title">请填写信息</span>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close" id="closeModalBtn">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form class="form-horizontal" id="modalForm">
                        <input type="hidden" id="id" name="id">
                        <div class="form-group">
                            <label class="col-sm-3 control-label">名称</label>
                            <div class="col-sm-7">
                                <input type="text" class="form-control" id="name" placeholder="请输入名称">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-3 control-label">时间</label>
                            <div class="col-sm-7">
                                <input type="datetime-local" class="form-control" id="time">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-3 control-label">关联笔记</label>
                            <div class="col-sm-7">
                                <select class="form-control" id="notesId"></select>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal" id="closeModalBtn">关闭</button>
                    <button type="button" class="btn btn-primary" id="saveBtn">保存</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="../js/jquery-1.10.2.js"></script>
<script src="../js/bootstrap.min.js"></script>
<script src="../js/vue2.6.11/axios.js"></script>
<script>
    $(document).ready(function() {
        let user = JSON.parse(localStorage.getItem('user'));
        $('#userName').text(user.name);

        let authority = [];
        let permission = [];
        let notesObjs = [];
        let currentPage = 1;

        // Fetch menu items based on authority
        axios.get("/authority").then(res => {
            if (res.data.code === '0') {
                authority = res.data.data;
                populateMenuItems();
            }
        });

        // Fetch notes
        axios.get("/notesInfo").then(res => {
            if (res.data.code === '0') {
                notesObjs = res.data.data;
                populateNotesDropdown();
            }
        });

        function populateMenuItems() {
            const menuItems = [
                { id: 1, name: '管理员信息', url: 'adminInfo.html' },
                { id: 2, name: '用户信息', url: 'userInfo.html' },
                { id: 3, name: '菜谱大类信息', url: 'classifyInfo.html' },
                { id: 4, name: '菜谱小类信息', url: 'subClassifyInfo.html' },
                { id: 5, name: '菜谱信息', url: 'foodsMenuInfo.html' },
                { id: 6, name: '食材信息', url: 'foodsMaterialInfo.html' },
                { id: 7, name: '收藏信息', url: 'collectInfo.html' },
                { id: 8, name: '笔记点赞信息', url: 'praiseInfo.html', active: true },
                { id: 9, name: '笔记信息', url: 'notesInfo.html' }
            ];

            let menuHtml = '';
            menuItems.forEach(item => {
                if (authority.includes(item.id)) {
                    menuHtml += `<li><a href="${item.url}" ${item.active ? 'class="active-menu"' : ''}><i class="fa fa-table"></i>${item.name}</a></li>`;
                }
            });
            $('#menuItems').html(menuHtml);
        }

        function populateNotesDropdown() {
            let optionsHtml = '';
            notesObjs.forEach(note => {
                optionsHtml += `<option value="${note.id}">${note.name}</option>`;
            });
            $('#notesId').html(optionsHtml);
        }

        // Load the table data
        function loadTable(pageNum) {
            let name = $('#searchInput').val() || 'all';
            axios.get(`/praiseInfo/page/${name}?pageNum=${pageNum}`).then(res => {
                if (res.data.code === '0') {
                    const objs = res.data.data.list;
                    const pageInfo = res.data.data;
                    currentPage = pageInfo.pageNum;

                    let tableHtml = '';
                    objs.forEach(obj => {
                        tableHtml += `
                            <tr>
                                <td>${obj.id}</td>
                                <td>${obj.name}</td>
                                <td>${obj.time}</td>
                                <td>${obj.notesName}</td>
                                <td>
                                    <button class="btn btn-primary btn-xs editBtn" data-id="${obj.id}">编辑</button>
                                    <button class="btn btn-danger btn-xs deleteBtn" data-id="${obj.id}">删除</button>
                                </td>
                            </tr>
                        `;
                    });
                    $('#tableBody').html(tableHtml);

                    // Handle pagination
                    let paginationHtml = `
                        <li class="page-item ${pageInfo.hasPreviousPage ? '' : 'disabled'}"><a class="page-link" href="javascript:void(0)" data-page="${currentPage - 1}">上一页</a></li>
                        <li class="page-item disabled"><a class="page-link" href="javascript:void(0)">${currentPage}</a></li>
                        <li class="page-item ${pageInfo.hasNextPage ? '' : 'disabled'}"><a class="page-link" href="javascript:void(0)" data-page="${currentPage + 1}">下一页</a></li>
                    `;
                    $('#pagination').html(paginationHtml);
                }
            });
        }

        // Event Handlers
        $('#addBtn').on('click', function() {
            $('#id').val('');
            $('#name').val('');
            $('#time').val('');
            $('#notesId').val('');
            $('#mod').modal('show');
        });

        $('#searchInput').on('keyup', function() {
            loadTable(currentPage);
        });

        $(document).on('click', '.editBtn', function() {
            const id = $(this).data('id');
            // Fetch data for the specific record
            axios.get(`/praiseInfo/${id}`).then(res => {
                if (res.data.code === '0') {
                    const obj = res.data.data;
                    $('#id').val(obj.id);
                    $('#name').val(obj.name);
                    $('#time').val(obj.time);
                    $('#notesId').val(obj.notesId);
                    $('#mod').modal('show');
                }
            });
        });

        $(document).on('click', '.deleteBtn', function() {
            const id = $(this).data('id');
            if (confirm("确认删除？")) {
                axios.delete(`/praiseInfo/${id}`).then(res => {
                    if (res.data.code === '0') {
                        alert('删除成功');
                        loadTable(currentPage);
                    }
                });
            }
        });

        $('#saveBtn').on('click', function() {
            const data = {
                id: $('#id').val(),
                name: $('#name').val(),
                time: $('#time').val(),
                notesId: $('#notesId').val()
            };

            if (data.id) {
                // Update record
                axios.put(`/praiseInfo`, data).then(res => {
                    if (res.data.code === '0') {
                        alert('更新成功');
                        $('#mod').modal('hide');
                        loadTable(currentPage);
                    }
                });
            } else {
                // Add new record
                axios.post(`/praiseInfo`, data).then(res => {
                    if (res.data.code === '0') {
                        alert('添加成功');
                        $('#mod').modal('hide');
                        loadTable(currentPage);
                    }
                });
            }
        });

        $(document).on('click', '.page-link', function() {
            const page = $(this).data('page');
            if (page) {
                loadTable(page);
            }
        });

        $('#logoutBtn').on('click', function() {
            localStorage.removeItem("user");
            window.location.href = '/login.html';
        });

        loadTable(currentPage);
    });
</script>
</body>
</html>
